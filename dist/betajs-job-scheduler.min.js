/*!
betajs-job-scheduler - v0.0.4 - 2019-09-25
Copyright (c) Oliver Friedmann,Ziggeo
Apache-2.0 Software License.
*/

var Scoped=function(){var p=function(){return{get:function(e){return"undefined"!=typeof window?e?window[e]:window:"undefined"!=typeof global?e?global[e]:global:"undefined"!=typeof self?e?self[e]:self:undefined},set:function(e,t){return"undefined"!=typeof window&&(window[e]=t),"undefined"!=typeof global&&(global[e]=t),"undefined"!=typeof self&&(self[e]=t),t},getPath:function(e){if(!e)return this.get();var t=e.split(".");if(1==t.length)return this.get(e);for(var n=this.get(t[0]),r=1;r<t.length;++r){if(!n)return n;n=n[t[r]]}return n},setPath:function(e,t){var n=e.split(".");if(1==n.length)return this.set(e,t);for(var r=this.get(n[0])||this.set(n[0],{}),i=1;i<n.length-1;++i)n[i]in r||(r[n[i]]={}),r=r[n[i]];return r[n[n.length-1]]=t}}}.call(this),f=function(){return{method:function(e,t){return function(){return t.apply(e,arguments)}},extend:function(e,t){for(var n in e=e||{},t=t||{})e[n]=t[n];return e},typeOf:function(e){return"[object Array]"===Object.prototype.toString.call(e)?"array":typeof e},isEmpty:function(e){if(null==e)return!0;if("array"==this.typeOf(e))return 0===e.length;if("object"!=typeof e)return!1;for(var t in e)return!1;return!0},matchArgs:function(e,t){var n=0,r={};for(var i in t)!0===t[i]||this.typeOf(e[n])==t[i]?(r[i]=e[n],n++):"undefined"==this.typeOf(e[n])&&n++;return r},stringify:function(e){return"function"==this.typeOf(e)?""+e:JSON.stringify(e)}}}.call(this),a=function(){return{__namespace:"Scoped",__revert:null,upgrade:function(e){var t=p.get(e||a.__namespace);if(t&&"object"==f.typeOf(t)&&t.guid==this.guid&&"string"==f.typeOf(t.version)){for(var n=this.version.split("."),r=t.version.split("."),i=!1,o=0;o<Math.min(n.length,r.length)&&(i=parseInt(n[o],10)>parseInt(r[o],10),n[o]==r[o]);++o);return i?this.attach(e):t}return this.attach(e)},attach:function(e){e&&(a.__namespace=e);var t=p.get(a.__namespace);if(t==this)return this;if(a.__revert=t)try{var n=t.__exportScoped();this.__exportBackup=this.__exportScoped(),this.__importScoped(n)}catch(r){}return p.set(a.__namespace,this),this},detach:function(e){return e&&p.set(a.__namespace,null),"undefined"!=typeof a.__revert&&p.set(a.__namespace,a.__revert),delete a.__revert,a.__exportBackup&&this.__importScoped(a.__exportBackup),this},exports:function(e,t,n){return"object"==typeof(e=e||("undefined"!=typeof module?module:null))&&e&&"exports"in e&&(n||e.exports==this||!e.exports||f.isEmpty(e.exports))&&(e.exports=t||this),this}}}.call(this);function _(e){var a={tree:"boolean"==typeof e.tree&&e.tree,global:"boolean"==typeof e.global&&e.global,root:"object"==typeof e.root?e.root:{}};function i(e){return{route:"string"==typeof e.route?e.route:null,parent:"object"==typeof e.parent?e.parent:null,ready:"boolean"==typeof e.ready&&e.ready,children:{},watchers:[],data:{},lazy:[]}}var s=i({ready:!0});if(a.tree)if(a.global){try{window&&(s.data=window)}catch(t){}try{global&&(s.data=global)}catch(t){}try{self&&(s.data=self)}catch(t){}}else s.data=a.root;function c(e){if(!e.ready)if(!e.parent||e.parent.ready){if(e.route&&e.parent&&e.route in e.parent.data){e.data=e.parent.data[e.route],e.ready=!0;for(var t=0;t<e.watchers.length;++t)e.watchers[t].callback.call(e.watchers[t].context||this,e.data);for(var n in e.watchers=[],e.children)c(e.children[n])}}else c(e.parent)}function o(e,t){if("object"==typeof t&&e.ready)for(var n in t)e.data[n]=t[n];else e.data=t;if("object"==typeof t)for(var r in t)e.children[r]&&(e.children[r].data=t[r]);for(var i in function o(e){if(!e.ready){e.parent&&!e.parent.ready&&o(e.parent),e.ready=!0,e.parent&&a.tree&&"object"==typeof e.parent.data&&(e.parent.data[e.route]=e.data);for(var t=0;t<e.watchers.length;++t)e.watchers[t].callback.call(e.watchers[t].context||this,e.data);e.watchers=[]}}(e),e.children)c(e.children[i])}function u(e){if(!e)return s;for(var t=e.split("."),n=s,r=0;r<t.length;++r)t[r]in n.children?n=n.children[t[r]]:(n.children[t[r]]=i({parent:n,route:t[r]}),c(n=n.children[t[r]]));return n}return{extend:function(e,t){o(u(e),t)},set:function(e,t){var n=u(e);n.data&&function r(e){if(e.ready&&e.data)for(var t in e.data)delete e.data[t]}(n),o(n,t)},get:function(e){var t=u(e);return t.ready?t.data:null},lazy:function(e,t,n){var r=u(e);r.ready?t(n||this,r.data):r.lazy.push({callback:t,context:n})},digest:function(e){c(u(e))},obtain:function(e,t,n){!function i(e,t,n){if(e.ready)t.call(n||this,e.data);else if(e.watchers.push({callback:t,context:n}),0<e.lazy.length){var r=function(e){if(0<e.lazy.length){var t=e.lazy.shift();t.callback.call(t.context||this,e.data),r(e)}};r(e)}}(u(e),t,n)},unresolvedWatchers:function(e){return function o(e,t,n){for(var r in n=n||[],!(e=e||s).ready&&0===e.lazy.length&&0<e.watchers.length&&n.push(t),e.children){var i=e.children[r];n=o(i,(t?t+".":"")+i.route,n)}return n}(u(e),e)},__export:function(){return{options:a,nsRoot:s}},__import:function(e){a=e.options,s=e.nsRoot}}}var t=_({tree:!0,global:!0}),n=_({tree:!0}),r=function g(e,t,n,r){var i=null,o=[],a=t,s=n,c=r,u=_({tree:!0}),l=_({tree:!1}),d={global:{namespace:c},root:{namespace:s},local:{namespace:u},"default":{namespace:l},parent:{namespace:a},scope:{namespace:u,readonly:!1}},h=function(o,a,s){var c=f.matchArgs(o,{options:"object",namespaceLocator:!0,dependencies:"array",hiddenDependencies:"array",callback:!0,context:"object"}),e=f.extend({lazy:this.options.lazy},c.options||{}),u=this.resolve(c.namespaceLocator),t=function(){this.require(c.dependencies,c.hiddenDependencies,function(){for(var e=[],t=0;t<arguments.length;++t)e.push(arguments[t]);if(e[e.length-1].ns=u,this.options.compile){for(var n=[],r=0;r<o.length;++r)n.push(f.stringify(o[r]));this.compiled+=this.options.ident+"."+a+"("+n.join(", ")+");\n\n"}this.options.dependencies&&(this.dependencies[u.path]=this.dependencies[u.path]||{},c.dependencies&&c.dependencies.forEach(function(e){this.dependencies[u.path][this.resolve(e).path]=!0},this),c.hiddenDependencies&&c.hiddenDependencies.forEach(function(e){this.dependencies[u.path][this.resolve(e).path]=!0},this));var i=this.options.compile?{}:c.callback.apply(c.context||this,e);s.call(this,u,i)},this)};return e.lazy?u.namespace.lazy(u.path,t,this):t.apply(this),this};return{getGlobal:f.method(p,p.getPath),setGlobal:f.method(p,p.setPath),options:{lazy:!1,ident:"Scoped",compile:!1,dependencies:!1},compiled:"",dependencies:{},nextScope:function(){return i||(i=g(this,u,s,c)),i},subScope:function(){var e=this.nextScope();return o.push(e),i=null,e},binding:function(e,t,n){var r;return d[e]&&d[e].readonly||(r="string"!=f.typeOf(t)?{namespace:_({tree:!0,root:t}),path:null}:this.resolve(t),d[e]=f.extend(n,r)),this},resolve:function(e){var t=e.split(":");if(1==t.length)throw"The locator '"+t[0]+"' requires a namespace.";var n=d[t[0]];if(!n)throw"The namespace '"+t[0]+"' has not been defined (yet).";return{namespace:n.namespace,path:n.path&&t[1]?n.path+"."+t[1]:n.path||t[1]}},define:function(){return h.call(this,arguments,"define",function(e,t){if(e.namespace.get(e.path))throw"Scoped namespace "+e.path+" has already been defined. Use extend to extend an existing namespace instead";e.namespace.set(e.path,t)})},assumeVersion:function(){var o=f.matchArgs(arguments,{assumption:!0,dependencies:"array",callback:!0,context:"object",error:"string"}),e=o.dependencies||[];e.unshift(o.assumption),this.require(e,function(){var e=arguments,t=e[0].replace(/[^\d\.]/g,"");e[0]=t.split(".");for(var n=0;n<e[0].length;++n)e[0][n]=parseInt(e[0][n],10);if("function"===f.typeOf(o.callback)){if(!o.callback.apply(o.context||this,o))throw"Scoped Assumption '"+o.assumption+"' failed, value is "+t+(o.error?", but assuming "+o.error:"")}else for(var r=(o.callback+"").replace(/[^\d\.]/g,"").split("."),i=0;i<Math.min(e[0].length,r.length);++i)if(parseInt(r[i],10)>e[0][i])throw"Scoped Version Assumption '"+o.assumption+"' failed, value is "+t+", but assuming at least "+o.callback})},extend:function(){return h.call(this,arguments,"extend",function(e,t){e.namespace.extend(e.path,t)})},require:function(){var t=f.matchArgs(arguments,{dependencies:"array",hiddenDependencies:"array",callback:"function",context:"object"});t.callback=t.callback||function(){};var e=t.dependencies||[],n=e.concat(t.hiddenDependencies||[]),r=n.length,i=[],o={};if(r)for(var a=function(e){this.i<i.length&&(i[this.i]=e),0==--r&&(i.push(o),t.callback.apply(t.context||this.ctx,i))},s=0;s<n.length;++s){var c=this.resolve(n[s]);s<e.length&&i.push(null),c.namespace.obtain(c.path,a,{ctx:this,i:s})}else i.push(o),t.callback.apply(t.context||this,i);return this},digest:function(e){var t=this.resolve(e);return t.namespace.digest(t.path),this},unresolved:function(e){var t=this.resolve(e);return t.namespace.unresolvedWatchers(t.path)},__export:function(){return{parentNamespace:a.__export(),rootNamespace:s.__export(),globalNamespace:c.__export(),localNamespace:u.__export(),privateNamespace:l.__export()}},__import:function(e){a.__import(e.parentNamespace),s.__import(e.rootNamespace),c.__import(e.globalNamespace),u.__import(e.localNamespace),l.__import(e.privateNamespace)}}}(0,n,n,t),e=f.extend(r,function(){return{guid:"4b6878ee-cb6a-46b3-94ac-27d91f58d666",version:"0.0.19",upgrade:a.upgrade,attach:a.attach,detach:a.detach,exports:a.exports,__exportScoped:function(){return{globalNamespace:t.__export(),rootNamespace:n.__export(),rootScope:r.__export()}},__importScoped:function(e){t.__import(e.globalNamespace),n.__import(e.rootNamespace),r.__import(e.rootScope)}}}.call(this));return(e=e.upgrade()).exports(),e}.call(this);(function(){var e=this.subScope();e.binding("module","global:BetaJS.Jobs"),e.binding("base","global:BetaJS"),e.binding("data","global:BetaJS.Data"),e.define("module:",function(){return{guid:"70ed7146-bb6d-4da4-97dc-5a8e2d23a23f",version:"0.0.4",datetime:1569453420500}}),e.assumeVersion("base:version","~1.0.141"),e.assumeVersion("data:version",""),e.extend("module:AbstractModel",["data:Modelling.Model","base:Objs","base:Promise","base:Time"],function(e,t,n,r,i){var o={STATE_CREATED:1,STATE_NOT_READY:11,STATE_READY:12,STATE_DISPATCHED:20,STATE_EXECUTING:30,STATE_CLOSED:40,STATE_INVALID:41,STATE_FAILED:42,STATE_FAILURE_EXCEEDING_RESOURCES:50,STATE_FAILURE_EXCEEDING_TIME:51,STATE_FAILURE_NO_PROGRESS:52,STATE_FAILURE_EXECUTION:53,STATE_FAILURE_DISPATCH:54},a=t.inverseKeyValue(o);return e.extend({scoped:i},function(e){return{_readyIn:function(){return 0},_resourcePredictions:function(){return{}},_timePrediction:function(){var e=this.executionProgress();return 0<e?this.runTime()/e:NaN},_stillValid:function(){return!0},readyIn:function(){return n.box(this._readyIn,this).timeoutError(this.cls.jobOptions.readyInTimeout,"timeout")},stillValid:function(){return n.box(this._stillValid,this).timeoutError(this.cls.jobOptions.stillValidTimeout,"timeout")},resourcePredictions:function(){return this._resourcePredictions()},timePrediction:function(){return this._timePrediction()},remainingTime:function(){switch(this.get("state")){case o.STATE_EXECUTING:return this.timePrediction()-this.runTime();case o.STATE_CLOSED:return 0;default:return NaN}},executionProgress:function(){switch(this.get("state")){case o.STATE_EXECUTING:return this.get("execution_progress");case o.STATE_CLOSED:return 1;default:return NaN}},runTime:function(){switch(this.get("state")){case o.STATE_EXECUTING:return r.now()-this.get("execution_start");case o.STATE_CLOSED:return this.get("execution_end")-this.get("execution_start");default:return NaN}},logProgress:function(e){this.set("execution_progress",e)},logResourceUsage:function(e){this.set("resource_usage",e);var n=t.clone(this.get("max_resource_usage")||{},1);t.iter(e,function(e,t){n[t]=Math.max(e,n[t]||0)}),this.set("max_resource_usage",n)},logLiveness:function(){this.set("execution_liveness",r.now())},livenessDelta:function(){var e=Math.max(this.get("execution_start"),this.get("execution_liveness"));return e?r.now()-e:0},transitionToReady:function(){return this.update({state:o.STATE_READY})},transitionToDispatchError:function(){return this.update({state:o.STATE_FAILURE_DISPATCH})},transitionToDispatched:function(e){return this.update({state:o.STATE_DISPATCHED,dispatch_receipt:e})},transitionToExecuting:function(){return this.update({state:o.STATE_EXECUTING,execution_start:r.now()})},transitionToClosed:function(){return this.update({state:o.STATE_CLOSED,execution_end:r.now()})},stateToString:function(){return a[this.get("state")]}}},function(e){return{STATES:o,STATES_INVERSE:a,_initializeScheme:function(){return t.extend({state:{type:"int",def:o.STATE_CREATED},resource_usage:{type:"object"},max_resource_usage:{type:"object"},execution_start:{type:"datetime"},execution_end:{type:"datetime"},execution_liveness:{type:"datetime",def:0},execution_progress:{type:"float",def:0},execution_count:{type:"int",def:0},ready_in_time:{type:"datetime",def:0},not_ready_count:{type:"int",def:0},dispatch_receipt:{},exceeding_resources_failure_count:{type:"int",def:0},exceeding_time_failure_count:{type:"int",def:0},no_progress_failure_count:{type:"int",def:0},job_execution_failure_count:{type:"int",def:0},failure_string:{type:"string",def:""}},e._initializeScheme.call(this))},jobOptions:{stillValidTimeout:!1,readyInTimeout:!1}}})}),e.extend("module:AbstractExecution",["base:Class","base:Objs","base:Events.EventsMixin","base:Timers.Timer","base:Time"],function(e,t,n,r,i,o){return e.extend({scoped:o},[n,function(n){return{constructor:function(e,t){n.constructor.call(this),this._jobModel=e,this._state=this.cls.STATES.IDLE,this._errorString=""},_run:function(){throw"not implemented"},_progress:function(){return NaN},_resourceUsage:function(){return{memory:process.memoryUsage().heapUsed,time:i.now()-this.jobModel().get("execution_start")}},_resourceUpperBounds:function(){return{memory:Infinity,time:Infinity}},jobModel:function(){return this._jobModel},state:function(){return this._state},run:function(){if(this._state!==this.cls.STATES.IDLE)throw"wrong state";this._state=this.cls.STATES.RUNNING,this._run(),this.cls.executionOptions.timer&&(this.__timer=this.auto_destroy(new r({context:this,fire:this.__fire,delay:this.cls.executionOptions.timer,start:!0})))},abort:function(){},__fire:function(){var e=this.progress();if(this.cls.executionOptions.livenessInterval){var t=this.jobModel().livenessDelta();this.jobModel().get("execution_progress")<e?this.trigger("liveness",this.jobModel().livenessDelta()):(this.trigger("unliveness",this.jobModel().livenessDelta()),t>this.cls.executionOptions.livenessInterval&&(this.trigger("failure-no-progress",t),this.abort()))}this.trigger("progress",e)},_jobSuccess:function(){this._state=this.cls.STATES.SUCCESS,this.trigger("success")},_jobFailed:function(e){this._state=this.cls.STATES.FAILED,this._errorString=e,this.trigger("failed",e)},progress:function(){return this._progress()},resourceUsage:function(){return this._resourceUsage()}}}],{STATES:{IDLE:1,RUNNING:2,SUCCESS:3,FAILED:4},executionOptions:{timer:1e3,livenessInterval:!1}})}),e.extend("module:DirectHandler",["module:Handler"],function(e,t){return e.extend({scoped:t},function(e){return{handleJob:function(e){return this._handleJob(e)}}})}),e.extend("module:Handler",["base:Class"],function(e,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this),this._scheduler=e},_handleJob:function(e){return this._scheduler.handleJob(e)}}})}),e.extend("module:DirectInvocation",["module:AbstractInvocation","base:Promise","base:Async"],function(e,n,r,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this),this._directHandler=e},_dispatchJob:function(e){return r.eventually(function(){this._directHandler.handleJob(e)},this),n.value({receipt:"direct"})}}})}),e.extend("module:AbstractInvocation",["base:Class","base:Promise"],function(e,t,n){return e.extend({scoped:n},function(e){return{_dispatchJob:function(e){return t.error("Abstract Method")},dispatchJob:function(e){return this._dispatchJob(e)}}})}),e.extend("module:Scheduler",["base:Class","base:Promise"],function(e,i,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this),this.jobTable=e.jobTable,this.JobModel=e.JobModel,this.ExecutionClass=e.ExecutionClass},setInvocation:function(e){this.invocation=e},dispatchJob:function(n){return n.get("state")!==n.cls.STATES.STATE_CREATED?i.error("Expected job model state to be CREATED"):n.save().mapSuccess(function(){return n.stillValid().mapError(function(){return n.transitionToNotReady()},this).mapSuccess(function(e){return e?n.readyIn().mapError(function(){return n.transitionToNotReady()},this).mapSuccess(function(e){return 0<e?n.transitionToNotReady(e):n.transitionToReady().mapSuccess(function(){return this.invocation.dispatchJob(n).mapCallback(function(e,t){return e?n.transitionToDispatchError():n.transitionToDispatched(t)},this)},this)},this):n.transitionToInvalid()},this)},this)},handleJob:function(r){return r.get("state")!==r.cls.STATES.STATE_DISPATCHED?i.error("Expected job model state to be DISPATCHED"):r.stillValid().mapError(function(){return r.transitionToNotReady()},this).mapSuccess(function(e){return e?r.readyIn().mapError(function(){return r.transitionToNotReady()},this).mapSuccess(function(e){if(0<e)return r.transitionToNotReady(e);var n=new this.ExecutionClass(r);return r.transitionToExecuting().mapSuccess(function(){var t=i.create();return n.on("success",function(e){r.transitionToClosed().callback(function(){t.asyncSuccess(e)})},this).on("progress",function(e){r.logProgress(e),r.logResourceUsage(n.resourceUsage())},this).on("liveness",function(){r.logLiveness()},this).on("failure-exceeding-resources",function(e){r.transitionFailureExceedingResources(e).callback(function(){t.asyncError("FailureExceedingResources")})},this).on("failure-exceeding-time",function(e){r.transitionFailureExceedingTime(e).callback(function(){t.asyncError("FailureExceedingTime")})},this).on("failure-no-progress",function(e){r.transitionFailureNoProgress(e).callback(function(){t.asyncError("FailureNoProgress")})},this).on("failure-execution",function(e){r.transitionFailureExecution(e).callback(function(){t.asyncError("FailureExecution")})},this),n.run(),t.callback(n.weakDestroy,n),t},this)},this):r.transitionToInvalid()},this)}}})})}).call(Scoped);