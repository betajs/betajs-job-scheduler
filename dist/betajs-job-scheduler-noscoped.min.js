/*!
betajs-job-scheduler - v0.0.5 - 2023-06-07
Copyright (c) Oliver Friedmann,Ziggeo
Apache-2.0 Software License.
*/

(function(){var e=this.subScope();e.binding("module","global:BetaJS.Jobs"),e.binding("base","global:BetaJS"),e.binding("data","global:BetaJS.Data"),e.define("module:",function(){return{guid:"70ed7146-bb6d-4da4-97dc-5a8e2d23a23f",version:"0.0.5",datetime:1686168918296}}),e.assumeVersion("base:version","~1.0.141"),e.assumeVersion("data:version",""),e.extend("module:AbstractModel",["data:Modelling.Model","base:Objs","base:Promise","base:Time"],function(e,t,n,i,r){var s={STATE_CREATED:1,STATE_NOT_READY:11,STATE_READY:12,STATE_DISPATCHED:20,STATE_EXECUTING:30,STATE_CLOSED:40,STATE_INVALID:41,STATE_FAILED:42,STATE_FAILURE_EXCEEDING_RESOURCES:50,STATE_FAILURE_EXCEEDING_TIME:51,STATE_FAILURE_NO_PROGRESS:52,STATE_FAILURE_EXECUTION:53,STATE_FAILURE_DISPATCH:54},o=t.inverseKeyValue(s);return e.extend({scoped:r},function(e){return{_readyIn:function(){return 0},readyIn:function(){return n.box(this._readyIn,this).timeoutError(this.cls.jobOptions.readyInTimeout,"timeout")},_stillValid:function(){return!0},stillValid:function(){return n.box(this._stillValid,this).timeoutError(this.cls.jobOptions.stillValidTimeout,"timeout")},_resourceEstimates:function(){return{}},resourceEstimates:function(){return this._resourceEstimates()},executionProgress:function(){switch(this.get("state")){case s.STATE_EXECUTING:return this.get("execution_progress");case s.STATE_CLOSED:return 1;default:return NaN}},runTime:function(){switch(this.get("state")){case s.STATE_EXECUTING:return i.now()-this.get("execution_start");case s.STATE_CLOSED:return this.get("execution_end")-this.get("execution_start");default:return NaN}},_timePrediction:function(){var e=this.executionProgress();return 0<e?this.runTime()/e:NaN},timePrediction:function(){return this._timePrediction()},remainingTime:function(){switch(this.get("state")){case s.STATE_EXECUTING:return this.timePrediction()-this.runTime();case s.STATE_CLOSED:return 0;default:return NaN}},logProgress:function(e){this.set("execution_progress",e)},logResourceUsage:function(e){this.set("resource_usage",e);var n=t.clone(this.get("max_resource_usage")||{},1);t.iter(e,function(e,t){n[t]=Math.max(e,n[t]||0)}),this.set("max_resource_usage",n)},logResourcePrediction:function(e){this.set("resource_prediction",e)},logLiveness:function(){this.set("execution_liveness",i.now())},livenessDelta:function(){var e=Math.max(this.get("execution_start"),this.get("execution_liveness"));return e?i.now()-e:0},transitionToReady:function(){return this.update({state:s.STATE_READY})},transitionToDispatchError:function(){return this.update({state:s.STATE_FAILURE_DISPATCH})},transitionToDispatched:function(e){return this.update({state:s.STATE_DISPATCHED,dispatch_receipt:e})},transitionToExecuting:function(){return this.update({state:s.STATE_EXECUTING,execution_start:i.now()})},transitionToClosed:function(){return this.update({state:s.STATE_CLOSED,execution_end:i.now()})},stateToString:function(){return o[this.get("state")]}}},function(e){return{STATES:s,STATES_INVERSE:o,_initializeScheme:function(){return t.extend({state:{type:"int",def:s.STATE_CREATED},resource_usage:{type:"object"},max_resource_usage:{type:"object"},resource_prediction:{type:"object"},execution_start:{type:"datetime"},execution_end:{type:"datetime"},execution_liveness:{type:"datetime",def:0},execution_progress:{type:"float",def:0},execution_count:{type:"int",def:0},ready_in_time:{type:"datetime",def:0},not_ready_count:{type:"int",def:0},dispatch_receipt:{},exceeding_resources_failure_count:{type:"int",def:0},exceeding_time_failure_count:{type:"int",def:0},no_progress_failure_count:{type:"int",def:0},job_execution_failure_count:{type:"int",def:0},failure_string:{type:"string",def:""}},e._initializeScheme.call(this))},jobOptions:{stillValidTimeout:!1,readyInTimeout:!1}}})}),e.extend("module:AbstractExecution",["base:Class","base:Objs","base:Events.EventsMixin","base:Timers.Timer","base:Time","base:Promise"],function(e,i,t,r,s,o,n){return e.extend({scoped:n},[t,function(n){return{constructor:function(e,t){n.constructor.call(this),this._jobModel=e,this._state=this.cls.STATES.IDLE,this._errorString="",t=i.extend({resourceMonitors:{}},t),this._resourceMonitors=t.resourceMonitors},_run:function(){throw"not implemented"},_progress:function(){return NaN},_resourceUsage:function(){return{memory:process.memoryUsage().heapUsed,time:s.now()-this.jobModel().get("execution_start")}},_resourceUpperBounds:function(){return{memory:Infinity,time:Infinity}},jobModel:function(){return this._jobModel},state:function(){return this._state},run:function(){if(this._state!==this.cls.STATES.IDLE)throw"wrong state";this._state=this.cls.STATES.RUNNING,this._initializedResources={},o.and(i.arrayify(this._resourceMonitors,function(e,t){return e.initialize().valueify(this._initializedResources,t)},this)).success(function(){this._run(),this.cls.executionOptions.timer&&(this.__timer=this.auto_destroy(new r({context:this,fire:this.__fire,delay:this.cls.executionOptions.timer,start:!0})))},this)},abort:function(){},__fire:function(){var e=this.progress();if(this.cls.executionOptions.livenessInterval){var t=this.jobModel().livenessDelta();this.jobModel().get("execution_progress")<e?this.trigger("liveness",this.jobModel().livenessDelta()):(this.trigger("unliveness",this.jobModel().livenessDelta()),t>this.cls.executionOptions.livenessInterval&&(this.trigger("failure-no-progress",t),this.abort()))}this.trigger("progress",e)},_jobSuccess:function(){this._state=this.cls.STATES.SUCCESS,this.trigger("success")},_jobFailed:function(e){this._state=this.cls.STATES.FAILED,this._errorString=e,this.trigger("failed",e)},progress:function(){return this._progress()},resourceUsage:function(){return this._resourceUsage()}}}],{STATES:{IDLE:1,RUNNING:2,SUCCESS:3,FAILED:4},executionOptions:{timer:1e3,livenessInterval:!1}})}),e.extend("module:AbstractResourceMonitor",["base:Class","base:Promise"],function(e,i,t){return e.extend({scoped:t},{_initialize:e.abstractFunction,_current:e.abstractFunction,_predict:e.abstractFunction,initialize:function(){return i.box(this._initialize,this)},current:function(){return i.box(this._current,this)},exceeding:function(e,t){return t&&t<e},predict:function(e,t,n){return i.box(this._predict,this,arguments)}})}),e.extend("module:DeltaResourceMonitor",["module:AbstractResourceMonitor"],function(e,t){return e.extend({scoped:t},{_current:function(t){return this.initialize().mapSuccess(function(e){return e-t})},_predict:function(e,t,n){return 0<n&&n<1?t/n:t}})}),e.extend("module:DiskspaceResourceMonitor",["module:DeltaResourceMonitor","base:Promise"],function(e,n,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this),this._filter=e},_initialize:function(){var e=n.create();return require("node-df")(e.asyncCallbackFunc()),e.mapSuccess(function(e){var n=0;return e.forEach(function(e){var t=!0;switch(typeof this._filter){case"function":t=this._filter(e);break;case"string":t=e.mount===this._filter}t&&(n+=e.used)},this),n})}}})}),e.extend("module:HeapResourceMonitor",["module:DeltaResourceMonitor"],function(e,t,n){return Class.extend({scoped:n},{_initialize:function(){return process.memoryUsage().heapUsed}})}),e.extend("module:MemoryResourceMonitor",["module:DeltaResourceMonitor"],function(e,t,n){return e.extend({scoped:n},{_initialize:function(){var e=require("os");return e.totalmem()-e.freemem()}})}),e.extend("module:TimeResourceMonitor",["module:DeltaResourceMonitor","base:Time"],function(e,t,n){return e.extend({scoped:n},{_initialize:function(){return t.now()}})}),e.extend("module:DirectHandler",["module:Handler"],function(e,t){return e.extend({scoped:t},function(e){return{handleJob:function(e){return this._handleJob(e)}}})}),e.extend("module:Handler",["base:Class"],function(e,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this),this._scheduler=e},_handleJob:function(e){return this._scheduler.handleJob(e)}}})}),e.extend("module:DirectInvocation",["module:AbstractInvocation","base:Promise","base:Async"],function(e,n,i,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this),this._directHandler=e},_dispatchJob:function(e){return i.eventually(function(){this._directHandler.handleJob(e)},this),n.value({receipt:"direct"})}}})}),e.extend("module:AbstractInvocation",["base:Class","base:Promise","base:Objs"],function(e,n,i,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this),e=e||{},this.__resourceUpperBounds=e.resourceUpperBounds||{}},_dispatchJob:function(e){return n.error("Abstract Method")},_resourceUpperBounds:function(e){return{}},resourceUpperBounds:function(e){return i.customMerge(this._resourceUpperBounds(e),this.__resourceUpperBounds,function(e,t,n){return Math.min(t,n)})},canHandle:function(e){var n=this.resourceUpperBounds(e);return i.all(e.resourceEstimates(),function(e,t){return!(t in n)||n[t]>=e})},dispatchJob:function(e){return this.canHandle(e)?this._dispatchJob(e):n.error("Estimates exceed resource bounds")}}})}),e.extend("module:Scheduler",["base:Class","base:Promise"],function(e,r,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this),this.jobTable=e.jobTable,this.JobModel=e.JobModel,this.ExecutionClass=e.ExecutionClass,this.resourceMonitors=e.resourceMonitors||{}},setInvocation:function(e){this.invocation=e},dispatchJob:function(n){return n.get("state")!==n.cls.STATES.STATE_CREATED?r.error("Expected job model state to be CREATED"):n.save().mapSuccess(function(){return n.stillValid().mapError(function(){return n.transitionToNotReady()},this).mapSuccess(function(e){return e?n.readyIn().mapError(function(){return n.transitionToNotReady()},this).mapSuccess(function(e){return 0<e?n.transitionToNotReady(e):n.transitionToReady().mapSuccess(function(){return this.invocation.dispatchJob(n).mapCallback(function(e,t){return e?n.transitionToDispatchError():n.transitionToDispatched(t)},this)},this)},this):n.transitionToInvalid()},this)},this)},handleJob:function(i){return i.get("state")!==i.cls.STATES.STATE_DISPATCHED?r.error("Expected job model state to be DISPATCHED"):i.stillValid().mapError(function(){return i.transitionToNotReady()},this).mapSuccess(function(e){return e?i.readyIn().mapError(function(){return i.transitionToNotReady()},this).mapSuccess(function(e){if(0<e)return i.transitionToNotReady(e);var n=new this.ExecutionClass(i,{resourceMonitors:this.resourceMonitors});return i.transitionToExecuting().mapSuccess(function(){var t=r.create();return n.on("success",function(e){i.transitionToClosed().callback(function(){t.asyncSuccess(e)})},this).on("progress",function(e){i.logProgress(e),i.logResourceUsage(n.resourceUsage())},this).on("liveness",function(){i.logLiveness()},this).on("failure-exceeding-resources",function(e){i.transitionFailureExceedingResources(e).callback(function(){t.asyncError("FailureExceedingResources")})},this).on("failure-exceeding-time",function(e){i.transitionFailureExceedingTime(e).callback(function(){t.asyncError("FailureExceedingTime")})},this).on("failure-no-progress",function(e){i.transitionFailureNoProgress(e).callback(function(){t.asyncError("FailureNoProgress")})},this).on("failure-execution",function(e){i.transitionFailureExecution(e).callback(function(){t.asyncError("FailureExecution")})},this),n.run(),t.callback(n.weakDestroy,n),t},this)},this):i.transitionToInvalid()},this)}}})})}).call(Scoped);