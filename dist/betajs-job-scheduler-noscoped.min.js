/*!
betajs-job-scheduler - v0.0.4 - 2019-09-25
Copyright (c) Oliver Friedmann,Ziggeo
Apache-2.0 Software License.
*/

(function(){var t=this.subScope();t.binding("module","global:BetaJS.Jobs"),t.binding("base","global:BetaJS"),t.binding("data","global:BetaJS.Data"),t.define("module:",function(){return{guid:"70ed7146-bb6d-4da4-97dc-5a8e2d23a23f",version:"0.0.4",datetime:1569453420500}}),t.assumeVersion("base:version","~1.0.141"),t.assumeVersion("data:version",""),t.extend("module:AbstractModel",["data:Modelling.Model","base:Objs","base:Promise","base:Time"],function(t,e,n,i,s){var r={STATE_CREATED:1,STATE_NOT_READY:11,STATE_READY:12,STATE_DISPATCHED:20,STATE_EXECUTING:30,STATE_CLOSED:40,STATE_INVALID:41,STATE_FAILED:42,STATE_FAILURE_EXCEEDING_RESOURCES:50,STATE_FAILURE_EXCEEDING_TIME:51,STATE_FAILURE_NO_PROGRESS:52,STATE_FAILURE_EXECUTION:53,STATE_FAILURE_DISPATCH:54},o=e.inverseKeyValue(r);return t.extend({scoped:s},function(t){return{_readyIn:function(){return 0},_resourcePredictions:function(){return{}},_timePrediction:function(){var t=this.executionProgress();return 0<t?this.runTime()/t:NaN},_stillValid:function(){return!0},readyIn:function(){return n.box(this._readyIn,this).timeoutError(this.cls.jobOptions.readyInTimeout,"timeout")},stillValid:function(){return n.box(this._stillValid,this).timeoutError(this.cls.jobOptions.stillValidTimeout,"timeout")},resourcePredictions:function(){return this._resourcePredictions()},timePrediction:function(){return this._timePrediction()},remainingTime:function(){switch(this.get("state")){case r.STATE_EXECUTING:return this.timePrediction()-this.runTime();case r.STATE_CLOSED:return 0;default:return NaN}},executionProgress:function(){switch(this.get("state")){case r.STATE_EXECUTING:return this.get("execution_progress");case r.STATE_CLOSED:return 1;default:return NaN}},runTime:function(){switch(this.get("state")){case r.STATE_EXECUTING:return i.now()-this.get("execution_start");case r.STATE_CLOSED:return this.get("execution_end")-this.get("execution_start");default:return NaN}},logProgress:function(t){this.set("execution_progress",t)},logResourceUsage:function(t){this.set("resource_usage",t);var n=e.clone(this.get("max_resource_usage")||{},1);e.iter(t,function(t,e){n[e]=Math.max(t,n[e]||0)}),this.set("max_resource_usage",n)},logLiveness:function(){this.set("execution_liveness",i.now())},livenessDelta:function(){var t=Math.max(this.get("execution_start"),this.get("execution_liveness"));return t?i.now()-t:0},transitionToReady:function(){return this.update({state:r.STATE_READY})},transitionToDispatchError:function(){return this.update({state:r.STATE_FAILURE_DISPATCH})},transitionToDispatched:function(t){return this.update({state:r.STATE_DISPATCHED,dispatch_receipt:t})},transitionToExecuting:function(){return this.update({state:r.STATE_EXECUTING,execution_start:i.now()})},transitionToClosed:function(){return this.update({state:r.STATE_CLOSED,execution_end:i.now()})},stateToString:function(){return o[this.get("state")]}}},function(t){return{STATES:r,STATES_INVERSE:o,_initializeScheme:function(){return e.extend({state:{type:"int",def:r.STATE_CREATED},resource_usage:{type:"object"},max_resource_usage:{type:"object"},execution_start:{type:"datetime"},execution_end:{type:"datetime"},execution_liveness:{type:"datetime",def:0},execution_progress:{type:"float",def:0},execution_count:{type:"int",def:0},ready_in_time:{type:"datetime",def:0},not_ready_count:{type:"int",def:0},dispatch_receipt:{},exceeding_resources_failure_count:{type:"int",def:0},exceeding_time_failure_count:{type:"int",def:0},no_progress_failure_count:{type:"int",def:0},job_execution_failure_count:{type:"int",def:0},failure_string:{type:"string",def:""}},t._initializeScheme.call(this))},jobOptions:{stillValidTimeout:!1,readyInTimeout:!1}}})}),t.extend("module:AbstractExecution",["base:Class","base:Objs","base:Events.EventsMixin","base:Timers.Timer","base:Time"],function(t,e,n,i,s,r){return t.extend({scoped:r},[n,function(n){return{constructor:function(t,e){n.constructor.call(this),this._jobModel=t,this._state=this.cls.STATES.IDLE,this._errorString=""},_run:function(){throw"not implemented"},_progress:function(){return NaN},_resourceUsage:function(){return{memory:process.memoryUsage().heapUsed,time:s.now()-this.jobModel().get("execution_start")}},_resourceUpperBounds:function(){return{memory:Infinity,time:Infinity}},jobModel:function(){return this._jobModel},state:function(){return this._state},run:function(){if(this._state!==this.cls.STATES.IDLE)throw"wrong state";this._state=this.cls.STATES.RUNNING,this._run(),this.cls.executionOptions.timer&&(this.__timer=this.auto_destroy(new i({context:this,fire:this.__fire,delay:this.cls.executionOptions.timer,start:!0})))},abort:function(){},__fire:function(){var t=this.progress();if(this.cls.executionOptions.livenessInterval){var e=this.jobModel().livenessDelta();this.jobModel().get("execution_progress")<t?this.trigger("liveness",this.jobModel().livenessDelta()):(this.trigger("unliveness",this.jobModel().livenessDelta()),e>this.cls.executionOptions.livenessInterval&&(this.trigger("failure-no-progress",e),this.abort()))}this.trigger("progress",t)},_jobSuccess:function(){this._state=this.cls.STATES.SUCCESS,this.trigger("success")},_jobFailed:function(t){this._state=this.cls.STATES.FAILED,this._errorString=t,this.trigger("failed",t)},progress:function(){return this._progress()},resourceUsage:function(){return this._resourceUsage()}}}],{STATES:{IDLE:1,RUNNING:2,SUCCESS:3,FAILED:4},executionOptions:{timer:1e3,livenessInterval:!1}})}),t.extend("module:DirectHandler",["module:Handler"],function(t,e){return t.extend({scoped:e},function(t){return{handleJob:function(t){return this._handleJob(t)}}})}),t.extend("module:Handler",["base:Class"],function(t,e){return t.extend({scoped:e},function(e){return{constructor:function(t){e.constructor.call(this),this._scheduler=t},_handleJob:function(t){return this._scheduler.handleJob(t)}}})}),t.extend("module:DirectInvocation",["module:AbstractInvocation","base:Promise","base:Async"],function(t,n,i,e){return t.extend({scoped:e},function(e){return{constructor:function(t){e.constructor.call(this),this._directHandler=t},_dispatchJob:function(t){return i.eventually(function(){this._directHandler.handleJob(t)},this),n.value({receipt:"direct"})}}})}),t.extend("module:AbstractInvocation",["base:Class","base:Promise"],function(t,e,n){return t.extend({scoped:n},function(t){return{_dispatchJob:function(t){return e.error("Abstract Method")},dispatchJob:function(t){return this._dispatchJob(t)}}})}),t.extend("module:Scheduler",["base:Class","base:Promise"],function(t,s,e){return t.extend({scoped:e},function(e){return{constructor:function(t){e.constructor.call(this),this.jobTable=t.jobTable,this.JobModel=t.JobModel,this.ExecutionClass=t.ExecutionClass},setInvocation:function(t){this.invocation=t},dispatchJob:function(n){return n.get("state")!==n.cls.STATES.STATE_CREATED?s.error("Expected job model state to be CREATED"):n.save().mapSuccess(function(){return n.stillValid().mapError(function(){return n.transitionToNotReady()},this).mapSuccess(function(t){return t?n.readyIn().mapError(function(){return n.transitionToNotReady()},this).mapSuccess(function(t){return 0<t?n.transitionToNotReady(t):n.transitionToReady().mapSuccess(function(){return this.invocation.dispatchJob(n).mapCallback(function(t,e){return t?n.transitionToDispatchError():n.transitionToDispatched(e)},this)},this)},this):n.transitionToInvalid()},this)},this)},handleJob:function(i){return i.get("state")!==i.cls.STATES.STATE_DISPATCHED?s.error("Expected job model state to be DISPATCHED"):i.stillValid().mapError(function(){return i.transitionToNotReady()},this).mapSuccess(function(t){return t?i.readyIn().mapError(function(){return i.transitionToNotReady()},this).mapSuccess(function(t){if(0<t)return i.transitionToNotReady(t);var n=new this.ExecutionClass(i);return i.transitionToExecuting().mapSuccess(function(){var e=s.create();return n.on("success",function(t){i.transitionToClosed().callback(function(){e.asyncSuccess(t)})},this).on("progress",function(t){i.logProgress(t),i.logResourceUsage(n.resourceUsage())},this).on("liveness",function(){i.logLiveness()},this).on("failure-exceeding-resources",function(t){i.transitionFailureExceedingResources(t).callback(function(){e.asyncError("FailureExceedingResources")})},this).on("failure-exceeding-time",function(t){i.transitionFailureExceedingTime(t).callback(function(){e.asyncError("FailureExceedingTime")})},this).on("failure-no-progress",function(t){i.transitionFailureNoProgress(t).callback(function(){e.asyncError("FailureNoProgress")})},this).on("failure-execution",function(t){i.transitionFailureExecution(t).callback(function(){e.asyncError("FailureExecution")})},this),n.run(),e.callback(n.weakDestroy,n),e},this)},this):i.transitionToInvalid()},this)}}})})}).call(Scoped);